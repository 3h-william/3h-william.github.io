<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>3h_william</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="技术/产品博客">
<meta property="og:type" content="website">
<meta property="og:title" content="3h_william">
<meta property="og:url" content="http://3h-william.github.io/index.html">
<meta property="og:site_name" content="3h_william">
<meta property="og:description" content="技术/产品博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3h_william">
<meta name="twitter:description" content="技术/产品博客">
    

    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">3h_william</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/me.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/me.jpg" />
            <h2 id="name">3h_william</h2>
            <h3 id="title">Bigdata Team Manager Architect</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Shanghai, China</span>
            <a id="follow" target="_blank" href="http://www.weibo.com/3hwilliam">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                12
                <span>posts</span>
            </div>
            <div class="article-info-block">
                15
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="/3h-william" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://www.weibo.com/3hwilliam" target="_blank" title="weibo" class=tooltip>
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-raft" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2019/01/09/raft/">raft协议的实现</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2019/01/09/raft/">
            <time datetime="2019-01-09T07:00:00.000Z" itemprop="datePublished">2019-01-09</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/etcd/">etcd</a>, <a class="tag-link" href="/tags/raft/">raft</a>, <a class="tag-link" href="/tags/技术架构/">技术架构</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>  一致性协议(共识机制) 的理论近年来借助于大数据、分布式系统、区块链等技术的发展，从理论到实践都有了很多成果，<br>  比如Zab的Zookeeper，Paxos的ElasticSearch，Raft的Etcd，还有各种区块链的共识一致性机制，比如 Pow , Pos , Dpos等等，<br>  这些协议和技术都是为了解决一个核心问题: 在分布式环境中，如何保证数据的一致性和可靠性。  </p>
<h1 id="什么Raft"><a href="#什么Raft" class="headerlink" title="什么Raft"></a>什么Raft</h1><p>  <a href="https://raft.github.io/" target="_blank" rel="external">Raft</a> 的主要思想和实现在许多篇文章中已经有阐述，这里不再复述，可以参阅<br>  <a href="https://www.infoq.cn/article/raft-paper" target="_blank" rel="external">raft-paper</a> 等文章  </p>
<h1 id="什么是Etcd"><a href="#什么是Etcd" class="headerlink" title="什么是Etcd"></a>什么是Etcd</h1><p>  <a href="https://github.com/etcd-io/etcd" target="_blank" rel="external">Etcd</a> 分布式的kv存储系统，当然对比一些诸如HBase/Cassandra 甚至Redis的 Nosql ,cache系统，<br>  etcd更多的优势是在于它的可靠性，可靠性的保证就是以raft为核心的一致性协议所提供</p>
<h1 id="Java实现"><a href="#Java实现" class="headerlink" title="Java实现"></a>Java实现</h1><p>  作者用Java语言，复刻了Golang etcd/raft的代码，用以学习和测试Raft协议，后续会不断添加新功能<br>  <a href="https://github.com/3h-william/raft" target="_blank" rel="external">raft-java</a></p>
<h1 id="Raft-Core的主要模块和架构"><a href="#Raft-Core的主要模块和架构" class="headerlink" title="Raft Core的主要模块和架构"></a>Raft Core的主要模块和架构</h1><p><img src="/img/raft/raft_core.png" alt=""></p>
<h2 id="RaftCore"><a href="#RaftCore" class="headerlink" title="RaftCore"></a>RaftCore</h2><p>   RaftCore是raft协议的核心</p>
<ol>
<li>逻辑控制<br>接受来自外部的Message请求并处理，是通过方法 Step 来处理。 不同的角色(Leader,Candidate,Follower)有各自的处理方法。<br>也包括了，是否发起自身竞争成为Leader的机制以及投票给其他Leader的机制。</li>
<li>RaftStatus<br>每一个节点都有存储了本节点关于Raft协议下的各种必要状态。 包括当前的term，leader信息，各类超时信息，以及一些配置参数。</li>
<li>Node Progress<br>如果该节点是Leader，会通过 Map<long ,="" progress=""> 来存储其他节点的状态，包括每一个节点本地commit日志的index等，用来同步数据。</long></li>
<li>Messages<br>再控制流转流程中，需要对外部发送的数据都会存放在Msg数组中</li>
</ol>
<h2 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h2><p>   定义了消息的状态信息，包括数据的信息，用以在不同节点中传输。消息是以Protbuf作为序列化</p>
<h2 id="Storeage"><a href="#Storeage" class="headerlink" title="Storeage"></a>Storeage</h2><p>   定义数据的存储方式。代码中以MemoryStorage来存储，用以测试核心流程<br>   Unstable 和 Snapshot配合存在。</p>
<h2 id="通信模块"><a href="#通信模块" class="headerlink" title="通信模块"></a>通信模块</h2><p>   通信模块也是可以自由实现，测试代码</p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2019/01/09/raft/" data-id="cjqov2qmx000e3q090hutxstg" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2019/01/09/raft/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-akka_split_brain" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/02/25/akka_split_brain/">Akka集群对于脑裂的策略</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/02/25/akka_split_brain/">
            <time datetime="2017-02-25T09:35:00.000Z" itemprop="datePublished">2017-02-25</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/akka/">akka</a>, <a class="tag-link" href="/tags/分布式系统/">分布式系统</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>一直以为，Akka的文档，是开源产品中写得较为优秀的，不但全面，而且有一定的深度。<br>在使用Akka Cluster的过程中，有几次关于脑裂的问题的发生，下面，就简单的介绍这篇文档:<br><a href="http://doc.akka.io/docs/akka/rp-16s01p01/scala/split-brain-resolver.html" target="_blank" rel="external">Split Brain Resolver</a></p>
<h1 id="什么是脑裂"><a href="#什么是脑裂" class="headerlink" title="什么是脑裂"></a>什么是脑裂</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">A fundamental problem in distributed systems is that network partitions (split brain scenarios) and machine crashes are indistinguishable for the observer, </div><div class="line">i.e. a node can observe that there is a problem with another node, but it cannot tell if it has crashed and will never be available again or </div><div class="line">if there is a network issue that might or might not heal again after a while. Temporary and permanent failures are indistinguishable because decisions must be made in finite time, </div><div class="line">and there always exists a temporary failure that lasts longer than the time limit for the decision.</div></pre></td></tr></table></figure>
<p>  简单的解释一下<br>  脑裂常常发身在网络故障的时候，把一个分布式的系统，分成了至少2个partitions。 并且这两个partitions不能识别出到底谁才是正常的，因为集群需要再一个有限的短时间内做出一个判断，而网络的故障的时间是不定。<br>  最终造成了整个集群处于一种不可用的状态。</p>
<h1 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h1><p>  所有策略的前提是，集群处于一个稳定的(stable)状态。 也就是说，在这个时间点，已经发生了脑裂，但是，不会有反复 (back and force )节点的 up/down。<br>  基于这个前提，akka提供了一些策略，来应付脑裂的情况</p>
<h2 id="1-Static-Quorum"><a href="#1-Static-Quorum" class="headerlink" title="1 Static Quorum"></a>1 Static Quorum</h2><p>  配置文件中，固定一个数值(static quorum) 当集群发生脑裂的时候，任何一个partition中的node &gt;= 过这个值，则认定是有效的。<br>  数值和集群有一关系  总节点数，必须小于 quorum-size * 2 - 1 ， 当然，也必须大于 quorum。</p>
<p>  这个策略的有点是， 在任何脑裂发生的时候，当产生两个 partition的时候，效果是非常显著的， 因为必然会推举出一个 partition 有效。 另一个无效。<br>  他的缺点是 :<br>  a)  quorum的数值是静态配置的，如果集群动态增加node，这个值必须随之而调整。<br>  b） 如果partitions的数量超过2。 比如 10 Nodes，static quorum最小的值是6 ，如果发生脑裂时，将集群划分为3个partition，分别是  (3,3,4) ，那么任何partition都无法运作。</p>
<p>  总的来说， Static Quorum相对简单粗放一些，可以应对大部分的异常，也有不少分布式系统使用的是这个策略， 比如 Elasticsearch。</p>
<h2 id="2-Keep-Majority"><a href="#2-Keep-Majority" class="headerlink" title="2 Keep Majority"></a>2 Keep Majority</h2><p>  基本规则是保留整个 partition中，拥有majority nodes的partition。<br>  他和 static quorum相比的好处是， 如果整个 cluster 的nodes数量是动态调整的，那么majority也是一个动态的值，这样会避免 static quorum的问题。<br>  但此策略依旧不能避免的是，如果两个 partitions所拥有的node数量是相同的，那么，整个 cluster 将会被终止。</p>
<p>  此外，akka提供了基于 keep majority，额外的一个配置项<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> akka.cluster.split-brain-resolver.keep-majority &#123;</div><div class="line">  # if the &apos;role&apos; is defined the decision is based only on members with that &apos;role&apos;</div><div class="line">  role = &quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以对于某些node定义他的价值，如果在多个partition中，拥有这些 valuable的节点数量较多的话，就会保留这个partition。<br>  这个选项对于一个多角色的集群，某些node是无状态的(stateless)的工作节点，他们相对而言价值较低，而某些节点可能是数据持久化节点，或者是Master节点。<br>  这样就可以区分出来多个Partition的价值，而保留价值高的部分。</p>
<h2 id="3-Keep-Oldest"><a href="#3-Keep-Oldest" class="headerlink" title="3 Keep Oldest"></a>3 Keep Oldest</h2><p>  顾名思义，整个集群只保留一个拥有最老节点的partition<br>  当然，有一个特例是，如果某一个partition，只有这一个oldest node，则这个partition会关闭它自己。<br>  这个策略适用于一些 Singleton 的场景，即某些特殊的服务只存在于 oldest的节点上。</p>
<h2 id="4-Keep-Referee"><a href="#4-Keep-Referee" class="headerlink" title="4 Keep Referee"></a>4 Keep Referee</h2><p>  这个策略和 Keepr oldest类似，只是把 oldest节点替换成了 referee节点，referee节点可以是cluster中的任意一台。</p>
<h1 id="Stable"><a href="#Stable" class="headerlink" title="Stable"></a>Stable</h1><p>  最后，回顾一个前提，所有的策略都必须基于集群稳定的情况下，才做出决定。<br>  在Cluster Singleton 和  Cluster Sharding 的过程中，新的Instance必须等到老的instance关闭。<br>  为了减少集群同时存在两个instance的情况， 有一个 duration 来保持集群(脑裂)状态的稳定。<br>  以下是akka的文档给出的建议:</p>
<p>  <img src="/img/akka_split_brain/p1.png" alt=""></p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2017/02/25/akka_split_brain/" data-id="cjqov2qmi00013q097fld6cjd" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2017/02/25/akka_split_brain/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-lft" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/01/24/lft/">新一代分布式调度系统--雷峰塔架构</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/01/24/lft/">
            <time datetime="2017-01-24T07:30:11.000Z" itemprop="datePublished">2017-01-24</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/akka/">akka</a>, <a class="tag-link" href="/tags/scala/">scala</a>, <a class="tag-link" href="/tags/技术产品/">技术产品</a>, <a class="tag-link" href="/tags/技术架构/">技术架构</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>  分布式任务调度系统工具很多，有Oozie ,Azkaban, airflow… ,大多数，都只能满足部分的需求。对于一个成熟的企业来说，只能当做工具，<br>  不能称之为产品。 对于一些特殊的定制化的需求，是无法满足的。<br>  因此，我们决定自主开发一个任务调度系统，定义为新一代调度系统，吸收各类调度系统的优点，并加以细化，基于Hadoop，不局限于Hadoop，提供完整的工作模式和工作机制。</p>
<h1 id="什么是雷峰塔"><a href="#什么是雷峰塔" class="headerlink" title="什么是雷峰塔"></a>什么是雷峰塔</h1><p>雷峰塔是新一代分布式任务调度系统。 可以通过扩展任务类型来丰富调度系统，同时也可以自定义WebUI的部分插件功能。<br>其中WebUI的部分功能设计是参考了 Azkaban 的设计风格。</p>
<h1 id="对比-Azkaban"><a href="#对比-Azkaban" class="headerlink" title="对比 Azkaban ?"></a>对比 Azkaban ?</h1><p>  更灵活的插件框架，满足更深的定制化需求。<br>  多个工作节点在不同机器上协同调度，可以通过自定义负载均衡来实现任务的分发。<br>  增加执行用户概念，一个执行器上可以用不同用户执行 Hadoop/Spark任务。</p>
<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>雷峰塔是一个分布式的任务调度系统。<br>其特点是 :<br> 便于部署<br> 插件灵活，扩展性感<br> Web UI 自定义</p>
<h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>雷峰塔架构是基于Master/Worker的架构模式<br><img src="/img/lft/lft_cluster_architecture.png" alt=""></p>
<h3 id="调度系统集群有三个角色"><a href="#调度系统集群有三个角色" class="headerlink" title="调度系统集群有三个角色"></a>调度系统集群有三个角色</h3><ol>
<li>Master<br>Master作为任务协调节点，对外Rest API节点。整个集群只能存在一个。</li>
<li>Worker<br>Worker节点作为具体任务执行节点。</li>
<li>Web<br>界面操作入口</li>
</ol>
<h3 id="Java-Scala-混合服务"><a href="#Java-Scala-混合服务" class="headerlink" title="Java + Scala 混合服务"></a>Java + Scala 混合服务</h3><pre><code>整个系统混合了 Java + Scala的代码编程
Java 主要处理对外接口逻辑层
Scala 主要应用于服务底层
其中，Akka 作为分布式的基础组件
插件模块核心用scala编程，也可以用Java/Scala实现自定义插件扩展
</code></pre><h3 id="HDFS-Mysql"><a href="#HDFS-Mysql" class="headerlink" title="HDFS + Mysql"></a>HDFS + Mysql</h3><p> 雷峰塔需要HDFS和Mysql (基本服务，如果有插件使用 Spark等还需要Yarn/Spark集群)的支持</p>
<ol>
<li>Mysql<br>作为整个调度系统的 工作流、任务、调度、权限等使用的数据库。 </li>
<li>HDFS<br>作为日志记录、调度资源共享的目录</li>
</ol>
<h2 id="工作流架构"><a href="#工作流架构" class="headerlink" title="工作流架构"></a>工作流架构</h2><p>以下是工作流提交的运行流程和机制<br><img src="/img/lft/work_flow_architecture.png" alt=""></p>
<h3 id="Flow-Job-Scheduler-Dependence-说明"><a href="#Flow-Job-Scheduler-Dependence-说明" class="headerlink" title="Flow /Job / Scheduler /Dependence 说明"></a>Flow /Job / Scheduler /Dependence 说明</h3><ol>
<li><p>Flow (工作流)<br>Flow定义为工作流，由其中字段DAG来 描述一个工作的执行流程，由一组Job组成。</p>
</li>
<li><p>Job  (任务)<br>Job定义为任务，描述具体任务是什么。</p>
</li>
<li><p>Scheduler (调度)<br>调度定义，描述了调度的定义</p>
</li>
<li><p>Dependence (资源)<br>定义了一种资源的表达，某一个任务所需要的一些 jars,配置文件，脚本，都可以放在Dependence 中,<br>其和任务是”多对一”的关系， 一个Dependence可以被多个Job所使用</p>
</li>
<li><p>Execution (执行)<br>Flow/Job/Scheduler 是静态概念， 一旦生成可执行的内容，生成与之对应的 FlowExecution,JobExecution和 SchedulerExecution</p>
</li>
</ol>
<h2 id="任务插件框架"><a href="#任务插件框架" class="headerlink" title="任务插件框架"></a>任务插件框架</h2><p><img src="/img/lft/plugin_architecture.png" alt=""></p>
<p>核心部分是 Job Framework ， 包含了 任务的解析，产生，到分发。<br>Job FrameWork : 开发者可以根据自己的使用场景，定制自己的任务解析器，包括任务的执行规则，流程等。</p>
<h2 id="Job-Framework"><a href="#Job-Framework" class="headerlink" title="Job Framework"></a>Job Framework</h2><p> 部分组件说明 :</p>
<ol>
<li><p>Job Plugin Conf 和 Job Plugin Jars<br>Job Plugin打包的类，必须在所有的Master/Worker节点都部署相同的内容，如果更新，需要重启整个集群 。</p>
</li>
<li><p>Job Serialized<br>Job 描述方式，以Json为明文的存储，JobDefine(Object)为序列化对象生成<br>Master根据配置文件、数据库内容、参数等，构建了一个 Job Define，并经过序列化后生成ExecutionRequestContent发送到 Worker，由Worker解析、执行</p>
</li>
<li><p>Job Generator<br>Job 生成器 ,在Master端执行，负责生成 Job Define</p>
</li>
<li><p>Job Executor<br>Job 执行器，在Worker端执行，负责解析 Job Define，并且执行具体的job</p>
</li>
</ol>
<h2 id="Load-Balance"><a href="#Load-Balance" class="headerlink" title="Load Balance"></a>Load Balance</h2><p>  任务分发策略，也支持自定义。<br>  目前支持的策略为: </p>
<ol>
<li>round-robin :        轮训选择一个节点执行</li>
<li>one-manually :       指定任务在某一个节点执行</li>
</ol>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2017/01/24/lft/" data-id="cjqov2qmv000c3q09d9z3wk0t" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2017/01/24/lft/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-akka" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/01/24/akka/">项目中，使用akka的一些经验和总结</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/01/24/akka/">
            <time datetime="2017-01-24T07:00:11.000Z" itemprop="datePublished">2017-01-24</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/akka/">akka</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Akka 是scala中，应该说不仅仅是scala，整个jvm语言领域，较为优秀的并发框架。 但是，由于国内使用的同僚少之又少，所以相关的资料较少。<br>大部分的资料和经验来自于 官网， <a href="http://akka.io/" target="_blank" rel="external">akka.io</a> ，还有一些奇奇乖乖的问题通过stackoverflow得意解决，最后，是在是解决不了的问题，需要多尝试，debug，等解决。<br>总之，最终不论是多少坑也好，多少弯路也好，算是把akka用了起来，构建了一个以akka为分布式集群核心的任务调度集群。每天的 job数量在 3000+，系统也是相对稳定，深感欣慰。 </p>
<h1 id="一些关键点"><a href="#一些关键点" class="headerlink" title="一些关键点"></a>一些关键点</h1><ol>
<li>Akka的Cluster，路由发现目前测试是有点问题的，路由的配置个人感觉也是有点繁琐，而且中间环节控制的不够好，所以不推荐使用。</li>
<li>在定义 Actor的时候，因为构建一个 Actor的时候，和初始化对象是不一样的。 所以如果再初始化 actor中发生异常，是无法在代码中捕获，只能通过parent的message来捕获<br>可以参考   <a href="http://stackoverflow.com/questions/18648390/how-should-an-akka-actor-be-created-that-might-throw-an-exception" target="_blank" rel="external">question</a><br>比较好的方式是，尽量保证在 初始化 Actor的时候， 减少异常发生的可能性(对数据库的操作)等。 </li>
<li>Actor中对于 Future的使用，取决于并发和串行。 该并发的时候用 Future，不该用的时候，就串行。 因为和 Java的线程模型的抽象程度不一样，所有不要用Java中的线程思维理解Akka中Message和Actor</li>
<li>Akka的失败机制。在任何一个 Actor中发生异常，如何处理，默认情况是交给 Parent的supervisor，但是策略也有多种，根据具体使用场景，可以自定义。 </li>
<li><p>最后，也是一个关键点，理解actor线程的模型，并发和串行，以及scala的异步线程池等概念，是设计复杂系统的基础。</p>
<hr>
</li>
</ol>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2017/01/24/akka/" data-id="cjqov2qme00003q09f4i04akp" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2017/01/24/akka/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-zookeeper_stuck_dns_network" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2015/11/10/zookeeper_stuck_dns_network/">使用Zookeeper过程中遇到客户端stuck的问题和解决建议</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/11/10/zookeeper_stuck_dns_network/">
            <time datetime="2015-11-10T01:18:11.000Z" itemprop="datePublished">2015-11-10</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/zookeeper/">zookeeper</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在查询一个和zookeeper相关的case。追查结果是一个称之为”Reverse DNS lookup”的问题。<br>可以称之为:反向DNS查找。 <a href="https://en.wikipedia.org/wiki/Reverse_DNS_lookup" target="_blank" rel="external">https://en.wikipedia.org/wiki/Reverse_DNS_lookup</a></p>
<h1 id="隐患"><a href="#隐患" class="headerlink" title="隐患"></a>隐患</h1><p>zookeeper 3.5以下的版本，会在客户端并发链接的时候，有一定几率发生stuck，随着并发连接的增多，发生概率越大。尤其是第一次创建连接的时候。<br>(因为zookeeper的client版本和server的版本兼容性，可以先升级客户端，客户端版本&gt;服务端版本，是支持的)</p>
<p>原因:<br>1)   归根结底，是因为DNS解析的问题。 可参考:<br><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1666" target="_blank" rel="external">issue 1666</a>   </p>
<p>2)   1666 issue在3.4.6已经fix，但是和它相关的另一个issue，只有在3.5才fix<br><a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1891" target="_blank" rel="external">issue 1891</a>  </p>
<h1 id="案例与解释"><a href="#案例与解释" class="headerlink" title="案例与解释"></a>案例与解释</h1><p>简单的来说，问题出在 “通过IP找HostName”，上， 例如: 通过”10.x.x.x”找到”hadoopXXX” 这个方法上。<br>在计算机网络中，我们可以用ip也可以用HostName来表明一台唯一的机器，我们也知道有一个叫做DNS的服务来帮助我们将IP转化为hostName. <strong>但是，这一个转换是有开销的</strong>。<br>是需要通过上层的DNS服务器或者IP机器本身的网卡来达到映射。<br>至于细节，可以参考wiki  </p>
<p>接下来，我们可以本地来模拟这个过程:<br>我们用Java可以启动以下代码，其中，注释的两行是两种构建方式。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">        for(int i=0;i&lt;100;i++)&#123;</div><div class="line">            new Thread(new Runnable() &#123;</div><div class="line">                @Override</div><div class="line">                public void run() &#123;</div><div class="line">//   1                 InetSocketAddress ia = new InetSocketAddress( &quot;10.x.x.x&quot;,2181);;</div><div class="line">//   2                 InetSocketAddress ia = new InetSocketAddress( &quot;hadoopXXX/10.x.x.x&quot;,2181);</div><div class="line">                    System.out.println(ia.getHostName());</div><div class="line">                &#125;</div><div class="line">            &#125;).start();</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<ul>
<li>当使用注释第一行的时候，线程是有很大的几率发生stuck.  </li>
<li>当使用注释第二行的时候，是不会有这个问题。<br>而不凑巧对的是，zookeeper3.5以下的版本中，是存在第一行注释的代码的。因此，问题就产生了。  </li>
</ul>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2015/11/10/zookeeper_stuck_dns_network/" data-id="cjqov2qmy000j3q09lahmrct0" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2015/11/10/zookeeper_stuck_dns_network/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-als_report" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2015/10/05/als_report/">推荐算法与协同过滤</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/10/05/als_report/">
            <time datetime="2015-10-05T06:08:11.000Z" itemprop="datePublished">2015-10-05</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/MachineLearning/">MachineLearning</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="注-只是个人半年前的一些研究总结，在此仅此记录。"><a href="#注-只是个人半年前的一些研究总结，在此仅此记录。" class="headerlink" title="(注: 只是个人半年前的一些研究总结，在此仅此记录。)"></a>(注: 只是个人半年前的一些研究总结，在此仅此记录。)</h1><h1 id="1-背景资料："><a href="#1-背景资料：" class="headerlink" title="1    背景资料："></a>1    背景资料：</h1><p>推荐系统基于两种策略：<br>a)    基于内容的过滤(Content-based filtering)<br>b)    协同过滤 (Collaborative filtering) (CF)<br>模型：<br>)    内容过滤需要根据内容创建模板，诸如用物品的title，名字。等等。<br>当然也可以根据用户建立模板。用户的画像等等。<br>b)    基于协同过滤。会从历史记录中，找出item-User之间的关系，并建立相关模型。<br>差异：<br>从某些场景来看，内容过滤更为优秀，比如一个新用户(没有任何的历史)。或是一个新商品，没有任何的关联数据。这个时候基于Content-Based的过滤，显得更恰当。<br>然而，在大多数的场景下，协同过滤会变得更为优秀。原因在于，他更充分的考虑到User-Item之间的关系。当然，该方法也使用的更为广泛。</p>
<h1 id="2-协同过滤的集中分类"><a href="#2-协同过滤的集中分类" class="headerlink" title="2 协同过滤的集中分类"></a>2 协同过滤的集中分类</h1><h2 id="2-1-基于物品的协同过滤"><a href="#2-1-基于物品的协同过滤" class="headerlink" title="2.1 基于物品的协同过滤"></a>2.1 基于物品的协同过滤</h2><p>构建  Item -&gt; User的向量: V(I-&gt;U)<br>      计算 各个Verctor之间的相似度<br>直观理解: 把和你之前喜欢的物品近似的物品推荐给你  </p>
<p><img src="/img/als_report/p1.jpg" alt=""></p>
<h2 id="2-2-基于用户的的协同过滤"><a href="#2-2-基于用户的的协同过滤" class="headerlink" title="2.2 基于用户的的协同过滤"></a>2.2 基于用户的的协同过滤</h2><p>构建  User -&gt; Item的向量: V(U-&gt;I)<br>      计算 各个Verctor之间的相似度<br>直观理解：把就是把与你有相同爱好的用户所喜欢的物品,推荐给你<br><img src="/img/als_report/p2.jpg" alt="">  </p>
<h2 id="2-3-比Item-CF和User-CF"><a href="#2-3-比Item-CF和User-CF" class="headerlink" title="2.3 比Item-CF和User-CF"></a>2.3 比Item-CF和User-CF</h2><p>ItemCF: 多样性不足 (覆盖率)<br>UserItem: 长尾性不足。<br>综合：兴趣点不同。</p>
<h2 id="2-4-于评分的协同过滤-Slope-One"><a href="#2-4-于评分的协同过滤-Slope-One" class="headerlink" title="2.4 于评分的协同过滤 (Slope One)"></a>2.4 于评分的协同过滤 (Slope One)</h2><p><img src="/img/als_report/p3.jpg" alt="">  </p>
<h1 id="3-SVD与协同过滤"><a href="#3-SVD与协同过滤" class="headerlink" title="3  SVD与协同过滤"></a>3  SVD与协同过滤</h1><h2 id="3-1-传统的SVD"><a href="#3-1-传统的SVD" class="headerlink" title="3.1  传统的SVD"></a>3.1  传统的SVD</h2><p>SVD (singular value decomposition) 奇异值分解。<br><img src="/img/als_report/p4.jpg" alt=""><br><img src="/img/als_report/a.jpg" alt=""></p>
<p>低阶近似： </p>
<ol>
<li>给定一个矩阵C，对其奇异值分解：  <img src="/img/als_report/a.jpg" alt=""></li>
<li>构造<img src="/img/als_report/a2.jpg" alt="">，它是将<img src="/img/als_report/a3.jpg" alt="">的第k+1行至M行设为零，也就是把<img src="/img/als_report/a3.jpg" alt="">的最小的r-k个(the r-k smallest)奇异值设为零。  </li>
<li>计算 <img src="/img/als_report/a4.jpg" alt=""><br>特征值数值的大小对矩阵-向量相乘影响的大小成正比，而奇异值和特征值也是正比关系，因此这里选取数值最小的r-k个特征值设为零合乎情理，即我们所希望的C-Ck尽可能的小</li>
</ol>
<h2 id="3-2-传统的SVD能否应用于协同过滤（基于评分）的模型"><a href="#3-2-传统的SVD能否应用于协同过滤（基于评分）的模型" class="headerlink" title="3.2  传统的SVD能否应用于协同过滤（基于评分）的模型?"></a>3.2  传统的SVD能否应用于协同过滤（基于评分）的模型?</h2><p>首先有几个问题 :<br>1．    传统的SVD对于高维稀疏矩阵实惠丢失一些特征信息。<br>2．    当矩阵不完全时，SVD是无法定义的。 （完全我的理解是有些值是没有定义 ，缺省，用latent factor 可以解）<br>3．    如果只对已知的信息求解，会非常容易过度拟合。 (我的理解:没有加入Lambda*规则化)<br>另外，要计算SVD的特征值，对于高维数据来说，也是代价巨大的。  </p>
<h2 id="3-3-SVD因式分解，实现协同过滤"><a href="#3-3-SVD因式分解，实现协同过滤" class="headerlink" title="3.3  SVD因式分解，实现协同过滤"></a>3.3  SVD因式分解，实现协同过滤</h2><p><img src="/img/als_report/p5.jpg" alt=""> </p>
<p><img src="/img/als_report/p6.jpg" alt=""> </p>
<h3 id="公式1-因式分解-plain"><a href="#公式1-因式分解-plain" class="headerlink" title="公式1 :  因式分解(plain)"></a>公式1 :  因式分解(plain)</h3><p><img src="/img/als_report/f1.jpg" alt=""><br>设定有那么一个转换，能够将已知的评分Matrix分解成两个Factor矩阵相乘。一个和Item相关，一个和User相关</p>
<h3 id="公式2-规则化-Lambda-L2"><a href="#公式2-规则化-Lambda-L2" class="headerlink" title="公式2:  规则化*Lambda (L2)"></a>公式2:  规则化*Lambda (L2)</h3><p>规则化的目的，是防止过度拟合。<br>其中Lambda太大，容易低拟合。Lambda太小，容易过拟合。<br>（这里的Lambda在Spark中需要根据实际的数据样本分布，维度的大小调整）<br>当然，这里用的是L2拟合。（区别于L1）,L2是二次函数拟合。<br>(L2拟合的目的是使得W的元素很小，接近于0，但不等于0，会使得模型简单。这样使得个别值对全局的印象降低，越简单的模型越不容易产生过拟合)<br><img src="/img/als_report/f2.jpg" alt="">  </p>
<h3 id="公式3-基线公式-偏好"><a href="#公式3-基线公式-偏好" class="headerlink" title="公式3  基线公式(偏好)"></a>公式3  基线公式(偏好)</h3><p><img src="/img/als_report/f3.jpg" alt=""><br>其中：<br>U是所有投票的均值<br>bu是用户打分相对于均值的偏差。<br>bi 是该item被打分相对于均值的偏差<br>(该公式是ALS算法的最原始形态)  </p>
<h3 id="公式4-单个打分"><a href="#公式4-单个打分" class="headerlink" title="公式4   单个打分"></a>公式4   单个打分</h3><p><img src="/img/als_report/f4.jpg" alt=""><br>该公式是由 (公式1 )  + (公式3) 推得<br>单条记录的打分  </p>
<h3 id="公式5-整体打分求最小化"><a href="#公式5-整体打分求最小化" class="headerlink" title="公式5   整体打分求最小化"></a>公式5   整体打分求最小化</h3><p><img src="/img/als_report/f5.jpg" alt=""><br>由以上同时推得。</p>
<h3 id="公式6-外部数据"><a href="#公式6-外部数据" class="headerlink" title="公式6   外部数据"></a>公式6   外部数据</h3><p>为了避免冷启动问题，需要加入外部数据。否则会导致新用户的数据非常少。<br>那么外部数据时什么？ 是基于该用户的一些其他特征（画像）<br><img src="/img/als_report/f6.jpg" alt=""> </p>
<h3 id="公式7-动态时间"><a href="#公式7-动态时间" class="headerlink" title="公式7   动态时间"></a>公式7   动态时间</h3><p><img src="/img/als_report/f7.jpg" alt=""><br>将时间作为权重考虑进去。<br>目的是：用户的倾向会随着时间而发生变化，使得更好的捕捉最新的趋势。  </p>
<h3 id="公式8-自信度（Implicit-latent-factor）"><a href="#公式8-自信度（Implicit-latent-factor）" class="headerlink" title="公式8  自信度（Implicit , latent factor）"></a>公式8  自信度（Implicit , latent factor）</h3><p><img src="/img/als_report/f8.jpg" alt=""><br>该公式和之后Spark中使用trainImplict的理论基本一致。<br>输入矩阵是不同的Confidence Levels</p>
<h3 id="几种优化结果："><a href="#几种优化结果：" class="headerlink" title="几种优化结果："></a>几种优化结果：</h3><p><img src="/img/als_report/p7.jpg" alt="">  </p>
<h1 id="4-Implict-Feedback"><a href="#4-Implict-Feedback" class="headerlink" title="4 Implict Feedback"></a>4 Implict Feedback</h1><p>显然，如果用户对于物品已经有的评分，这些数据称之为explicit。<br>但是，有些数据，诸如物品的点击数等，这些并不能直接反应用户对该物品的评分。只是表明了一种倾向，但是，究竟是正向的倾向，还是负向的倾向，是不确定的。  </p>
<p>Implicit feedback 的数据和 explicit data的数据是非常不同的:<br>a)     矩阵是完整定义了的。 （explicit的数据会有Miss）<br>b)     没有负向的反馈。 (没有明显的倾向)<br>c)     在0值的时候，是没有交互定义的。<br>d)     对于这部分数据，必然没有十足的把握（相对于显示的评分，信心不足）<br>e)     当然，用标准的SVD显然是无法求得这种关系的。</p>
<p>以下几张图可以一目了然其计算法则：<br><img src="/img/als_report/p8.jpg" alt="">  </p>
<p><img src="/img/als_report/p9.jpg" alt="">  </p>
<p><img src="/img/als_report/p10.jpg" alt="">  </p>
<p>但，Collaborative Filtering for Implicit Feedback Dataset  这篇论文暂时没有搜索到原文。<br>只能通过代码来分析其计算公式。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">val confidence = 1 + alpha * abs(rs(i))</div></pre></td></tr></table></figure>
<p>所以，在Spark中，参数为alpha的值，是用来调节自信率的。</p>
<h1 id="5-ALS和SGD"><a href="#5-ALS和SGD" class="headerlink" title="5 ALS和SGD"></a>5 ALS和SGD</h1><p>即便我们已经有了上述的许多公式，我们如何求解？</p>
<h2 id="5-1-随机梯度下降-SGD"><a href="#5-1-随机梯度下降-SGD" class="headerlink" title="5.1   随机梯度下降(SGD)"></a>5.1   随机梯度下降(SGD)</h2><p>Stochastic Gradient Descent  </p>
<p>在数学上，我们知道。 一个符合convex的函数是可以求得最小值的。<br>这样一来，我们就有了梯度下降的求解方法，其梯度下降的速度，取决于convex函数的凸性强不强。  </p>
<p><img src="/img/als_report/p11.jpg" alt=""><br>这就是梯度下降的迭代公式，当然，该算法已经应用于Mahout中实现。  </p>
<h2 id="5-2-ALS算法"><a href="#5-2-ALS算法" class="headerlink" title="5.2  ALS算法"></a>5.2  ALS算法</h2><p>Alternating Least Squares (交替最小方差算法)<br>该算法有两个优点:<br>1)    ALS更容易并行化。<br>2)    ALS对处理隐式数据更方便。   </p>
<p>根据5.1的公式中：<br><img src="/img/als_report/p12.jpg" alt=""></p>
<p>这两共公式各自有两个变量，我们可以固定其中一个变量，这样使得其编程一个二次函数，能够被最优化求解。<br>而ALS就是不断的交替固定Pu和Qi，然后求解另一个变量的最优值。<br>当然，通常来说,SGD会比ALS更加简单和快速，但是ALS的并行性比较好。如果矩阵是稀疏矩阵，那么ALS更有优势  </p>
<h1 id="6-算法的检验"><a href="#6-算法的检验" class="headerlink" title="6 算法的检验"></a>6 算法的检验</h1><p>RMSE/MSE/MAPK<br>待续….</p>
<h1 id="7-Reference"><a href="#7-Reference" class="headerlink" title="7 Reference"></a>7 Reference</h1><p>spark,als-ws 基础<br><a href="http://www2.research.att.com/~volinsky/papers/ieeecomputer.pdf" target="_blank" rel="external">http://www2.research.att.com/~volinsky/papers/ieeecomputer.pdf</a></p>
<p>协同过滤部分:<br><a href="http://www.ibm.com/developerworks/cn/web/1103_zhaoct_recommstudy2/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/web/1103_zhaoct_recommstudy2/index.html</a><br><a href="http://www.52ml.net/297.html" target="_blank" rel="external">http://www.52ml.net/297.html</a></p>
<p>svd 部分：<br><a href="http://blog.csdn.net/wangran51/article/details/7408414" target="_blank" rel="external">http://blog.csdn.net/wangran51/article/details/7408414</a><br><a href="http://blog.csdn.net/qianhen123/article/details/40077873" target="_blank" rel="external">http://blog.csdn.net/qianhen123/article/details/40077873</a></p>
<p>规则化:<br><a href="http://blog.csdn.net/u012162613/article/details/44261657" target="_blank" rel="external">http://blog.csdn.net/u012162613/article/details/44261657</a></p>
<p>Latent-factor-models<br><a href="http://www.slideshare.net/sscdotopen/latent-factor-models-for-collaborative-filtering" target="_blank" rel="external">http://www.slideshare.net/sscdotopen/latent-factor-models-for-collaborative-filtering</a></p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2015/10/05/als_report/" data-id="cjqov2qmm00033q09e5a1n8et" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2015/10/05/als_report/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-sqoop_orc" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2015/09/11/sqoop_orc/">使用sqoop生成ORC格式的文件，并给Hive加载</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/09/11/sqoop_orc/">
            <time datetime="2015-09-11T07:00:11.000Z" itemprop="datePublished">2015-09-11</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/hive/">hive</a>, <a class="tag-link" href="/tags/sqoop/">sqoop</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在当前版本: sqoop-1.4.5(CDH540)中的sqoop并不支持导出格式为orcfile的格式。因此，如果我们想将数据从DB=&gt;HDFS，并生成ORC格式，只有两个办法。</p>
<p>-&gt; a) 使用HCatalog服务，目前没有测试过，看文档是可以生成ORC的格式。<br>-&gt; b) 原始办法，通过Hive的insert命令将一张原本不是ORC格式的数据，导入到另一个ORC格式中，这样就有了ORC格式的文件。 但该方法会造成时间、资源消耗翻倍。</p>
<h1 id="DIY"><a href="#DIY" class="headerlink" title="DIY"></a>DIY</h1><p>既然如此，自己动手，丰衣足食。介于近年来对于sqoop的使用经验，很方便的定位到了几个地方，并加入了一些类和方法，最终达到了目的。当然，因为我们的需求目前仅仅是从DB = &gt; HDFS，即只是增加了import方法中的参数，并没有在export =&gt; DB中增加。</p>
<p>具体代码可以参考我已经提供的版本 <a href="https://github.com/3h-william/sqoop-orc-import" target="_blank" rel="external">link</a><br>使用ant编译后，替换原来的sqoop jar即可。</p>
<h1 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h1><p>-&gt; 1) 使用hive的提供的TypeInfoUtils 构建ORC file的Schema.并传递到每一个Map中<br>-&gt; 2) 使用 org.apache.hadoop.hive.ql.io.orc.OrcNewOutputFormat 作为输出格式</p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2015/09/11/sqoop_orc/" data-id="cjqov2qmx000g3q09ltf51tdk" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2015/09/11/sqoop_orc/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-hbase_balance_problem" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2015/09/08/hbase_balance_problem/">HBase Coprocessor问题引起异常Balance</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/09/08/hbase_balance_problem/">
            <time datetime="2015-09-08T06:08:11.000Z" itemprop="datePublished">2015-09-08</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/hbase/">hbase</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><p>最近发现HBase集群的文件compaction次数明显增加。经常到时M/R job扫描snapshot文件的时候发生文件找不到，为此trace了一下日志，大致发现了问题。<br><img src="/img/hbase_balance_problems/balance_metrics.png" alt="balance统计"></p>
<h1 id="问题大致流程Trace"><a href="#问题大致流程Trace" class="headerlink" title="问题大致流程Trace"></a>问题大致流程Trace</h1><ul>
<li>1)  全量索引M/R  job 失败   </li>
<li>2)  HFile文件不存在  </li>
<li>3)  HFile发生了compaction，文件被代替  </li>
<li>4)  HFile文件数量达到默认数量(3个) 触发Minor compaction  </li>
<li>5)  Memstore被flush，生成了HFile  </li>
<li>6)  HRegion 被close之前会触发flush (包括snapshot，倒到Memory的阀值也会触发)，但close是主要原因。  </li>
<li>7)  Cluster的Balance操作需要 Close &amp; Move HRegion  </li>
<li><p>8)  StochasticLoadBalancer HBase的Balance策略机制类，触发条件为:  </p>
<ul>
<li>a)  达到Balance触发条件 Max Region &gt; AVG(Region数量) +1  OR  Min Region &lt;AVG(Region数量) -1  </li>
<li>b)  调整后的Cost Function值比原来的小（策略更为优秀）<br>附:  CF的值:<br>new ReadRequestCostFunction(conf),<br>new WriteRequestCostFunction(conf),<br>new MemstoreSizeCostFunction(conf),<br>new StoreFileCostFunction(conf)</li>
</ul>
</li>
<li><p>9)  新增的Region数量并不多。不会经常触发balance</p>
</li>
<li>10)  Balance的大部分Region都是旧的Region，并且 无法调整到最优状态，导致不断调整，死循环。如下某一个时刻的Region分布:<br><img src="/img/hbase_balance_problems/regions_info.png" alt="region分布"></li>
</ul>
<p>只要Region数小于73或者大于76，就会满足条件a。<br>并且，如果机会调整之后的cost比较小，就会满足b。</p>
<ul>
<li>11)  调整不到平衡点，可能是因为某些调整失败。</li>
<li>12)  没有加载Phoenix coprocessor的机器如果balance 一些有该coprocessor的Region就会失败。</li>
<li>13)  大规模调整从9/3 18:00开始第一个balance周期。 </li>
<li>14)  9/3 17:57 分执行了truncate的操作。 </li>
</ul>
<h1 id="Balance-Trace"><a href="#Balance-Trace" class="headerlink" title="Balance Trace"></a>Balance Trace</h1><p>因为日志涉及公司信息，不再给出，大体步骤如下:<br>需要调整的Region号:  XXXXX</p>
<ul>
<li>Step 1: 将该Region从server12迁移到server24 (这台机器已dead)</li>
<li>Step 2: 因为迁移server24失败，所以选择另一台机器进行迁移，选择了server34</li>
<li>Step 3:  server34加载该Region失败，因为coprocessor的原因。</li>
<li>Step 4 : 选择server32迁移，也失败了，最终选择了server19成功</li>
</ul>
<p>Balance的总结:    </p>
<ul>
<li>a) 我们可以看到，Balance的策略是失败的，因为最初是想将这个Region迁移到server34，而最终却是迁移到了server19。  </li>
<li>b) 这样的balance，不仅仅是失败，而且会对server19增加了负担。</li>
<li>c) 从HBase代码我没有看到对这种情况的处理方式。但理论上一次失败是没有关系的，只要第二次Balance成功即可。</li>
<li>d) 但是，某些机器注定无法收容某些Region，所以，注定永远无法调整到一个平衡的balance掉。</li>
</ul>
<p>遗留问题:<br>从日志中有一个问题: server24这台机器在9/3 15:29已经dead，为何balance策略仍然会选择这台机器。是不是又bug…</p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2015/09/08/hbase_balance_problem/" data-id="cjqov2qmo00053q09l2bwg68w" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2015/09/08/hbase_balance_problem/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-hbase-bulkload" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2015/08/27/hbase-bulkload/">hbase bulkload 相关整理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/08/27/hbase-bulkload/">
            <time datetime="2015-08-27T06:08:11.000Z" itemprop="datePublished">2015-08-27</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/hbase/">hbase</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>由于近期Team内有同学用到bulkload,整理了一下过往我用到的bulkload的相关使用经验<br>基于<strong>hbase 0.90</strong>和<strong>0.94</strong>版本做一些简单的分析，可供参考。  </p>
<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a><strong>1. 概述</strong></h2><p><a href="http://hbase.apache.org/book.html#arch.bulk.load" target="_blank" rel="external">官方说明</a><br>[0.94官方说明] (<a href="http://hbase.apache.org/0.94/book/arch.bulk.load.html" target="_blank" rel="external">http://hbase.apache.org/0.94/book/arch.bulk.load.html</a>)  </p>
<p>简单的说，bluk load 是能够批量加载hfile =&gt; hbase的技术。<br>服务端，RegionServer处理客户端的bulkload请求。<br>客户端，向RegionServer发起blukload请求。  </p>
<h3 id="1-1-案例"><a href="#1-1-案例" class="headerlink" title="1.1. 案例"></a><strong>1.1. 案例</strong></h3><p>在2013年的maillog项目中，我们使用了bulk load技术。批量加载了从M/R生成的HFile数据。<br>因为是预先生成的HFile和处理过的，所以是一个HFile对应1个Region</p>
<h4 id="加载数据量"><a href="#加载数据量" class="headerlink" title="加载数据量:"></a><strong>加载数据量:</strong></h4><p>HFile(Region) 总数: <strong>100个</strong><br>占用磁盘大小 : <strong>450G</strong> (snappy压缩后<strong>100G</strong>)<br>消耗时间 : 在数据已经存在与HDFS的情况下，每一个HFile加载时间 <strong>小于 1秒</strong>    </p>
<h3 id="1-2-特性"><a href="#1-2-特性" class="headerlink" title="1.2 特性"></a><strong>1.2 特性</strong></h3><p><strong>a)</strong> bulkload 在加载的同时，并不会影响正常读写。(如果写文件造成分区变化，对bulkload有影响)<br><strong>b)</strong> bulkload 的加载是秒级的，在同一个HDFS cluster中，会将数据move。<br><strong>c)</strong> bulkload 也支持从不同的hdfs cluster copy数据(不同版本没有测试过)，同一个版本可行，它会把原来的move操作替换为copy，效率会降低。<br>(<strong>注意</strong>: 如果你的数据没有move而是copy，请check一下hdfs的URI写的是否正确一致)</p>
<h3 id="1-3-空表和非空表的策略"><a href="#1-3-空表和非空表的策略" class="headerlink" title="1.3. 空表和非空表的策略"></a><strong>1.3. 空表和非空表的策略</strong></h3><h4 id="场景定义"><a href="#场景定义" class="headerlink" title="场景定义"></a>场景定义</h4><p>bulkload 适用于初始化整个HBase表(空表)， 也适用于对于增量数据的导入（非空表）  </p>
<h4 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h4><p>显然，对于这两种场景的操作手法和策略是不同的。<br>对于任何的bulkload操作策略来说，评判目标应该是一致的: <strong>效率和影响</strong><br><strong>效率</strong> 指的是如何在短时间内将数据load。<br><strong>影响</strong> 指的是如何避免在做bulkload的时候，减少对集群的影响，避免hbase触发split/merge等heavy的操作。    </p>
<h4 id="操作手法一般包括："><a href="#操作手法一般包括：" class="headerlink" title="操作手法一般包括："></a>操作手法一般包括：</h4><p><strong>a) HFile的预处理</strong>  通过M/R Job或者其他手段预先处理HFile，可以定义HFile大小，splitkey规则，可以在非空表的情况下，极大避免对集群的影响。<br><strong>b) 预分区</strong>  通常来说，对于空表的bulkload应该是不会触发集群的split、merge等操作的。通过预分区可以有效的规避这一点。和Hbase 的split size结合使用。 </p>
<h2 id="2-Bulkload客户端流程"><a href="#2-Bulkload客户端流程" class="headerlink" title="2. Bulkload客户端流程"></a><strong>2. Bulkload客户端流程</strong></h2><p>主要围绕<strong>LoadIncrementalHFiles</strong> 类来说明基本的流程。<br>可参考我上传的代码，对比以下链接的代码<br>[0.90版本官方提供的LoadIncrementalHFiles类] (<a href="http://trgit2/wz68/importdb_blukload/blob/master/src/main/java/com/newegg/email/importdb/bulkload/tool/LoadIncrementalHFiles.java" target="_blank" rel="external">http://trgit2/wz68/importdb_blukload/blob/master/src/main/java/com/newegg/email/importdb/bulkload/tool/LoadIncrementalHFiles.java</a>)<br>[基于0.90版本修改后支持客户端并发的LoadIncrementalHFilesConcurrency类]  (<a href="http://trgit2/wz68/importdb_blukload/blob/master/src/main/java/com/newegg/email/importdb/bulkload/tool/LoadIncrementalHFilesConcurrency.java" target="_blank" rel="external">http://trgit2/wz68/importdb_blukload/blob/master/src/main/java/com/newegg/email/importdb/bulkload/tool/LoadIncrementalHFilesConcurrency.java</a>)<br>总的来说，这部分代码比较简单，客户端代码很容易读懂。</p>
<h3 id="Step-1-main-entry"><a href="#Step-1-main-entry" class="headerlink" title="Step 1.  main entry"></a>Step 1.  main entry</h3><p>  LoadIncrementalHFiles的entry方法，会接收两个参数，一个是表的名字，另一个是<strong>hfile文件或文件夹路径</strong>(此处可传递文件夹)<br>  这里的LoadIncrementalHFiles是implements于org.apache.hadoop.util.Tool，但是因为这里只是借助于tool这个工具，实质上并没有启动任何M/R job，因此我们看到的只是一个local的app启动。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">   // entry 方法</div><div class="line">   public static void main(String[] args) throws Exception &#123;</div><div class="line">       int ret = ToolRunner.run(new LoadIncrementalHFiles(HBaseConfiguration.create()), args);</div><div class="line">    System.exit(ret);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   // tool的默认加载方法run</div><div class="line">public int run(String[] args) throws Exception &#123;</div><div class="line">	if (args.length != 2) &#123;</div><div class="line">		usage();</div><div class="line">		return -1;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	String dirPath = args[0];      // ---&gt; 路径(文件、文件夹)</div><div class="line">	String tableName = args[1];    // ---&gt; table name</div><div class="line"></div><div class="line">	boolean tableExists = this.doesTableExist(tableName);</div><div class="line">	if (!tableExists)</div><div class="line">		this.createTable(tableName, dirPath);</div><div class="line"></div><div class="line">	Path hfofDir = new Path(dirPath);</div><div class="line">	HTable table = new HTable(conf,tableName);</div><div class="line"></div><div class="line">	doBulkLoad(hfofDir, table);   // ---&gt; 调用bulkload方法</div><div class="line">	return 0;                     // ---&gt;  Run方法中并没有调用M/R job client，因此只是一个local app，不能算是M/R的job</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Step-2-串行化和并行化-doBulkLoad"><a href="#Step-2-串行化和并行化-doBulkLoad" class="headerlink" title="Step 2 . 串行化和并行化 doBulkLoad"></a>Step 2 . 串行化和并行化 doBulkLoad</h3><p>串行化和并行化目前已经在高版本应该解决了。  </p>
<h4 id="a-0-90版本的串行化-以下这段是官方提供的代码，我们可以看到tryLoad是循环的。所以无法并发去做。"><a href="#a-0-90版本的串行化-以下这段是官方提供的代码，我们可以看到tryLoad是循环的。所以无法并发去做。" class="headerlink" title="a)  0.90版本的串行化: 以下这段是官方提供的代码，我们可以看到tryLoad是循环的。所以无法并发去做。"></a><strong>a)</strong>  0.90版本的串行化: 以下这段是官方提供的代码，我们可以看到tryLoad是循环的。所以无法并发去做。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">public void doBulkLoad(Path hfofDir, HTable table) throws TableNotFoundException, IOException &#123;</div><div class="line">	HConnection conn = table.getConnection();</div><div class="line"></div><div class="line">	if (!conn.isTableAvailable(table.getTableName())) &#123;</div><div class="line">		throw new TableNotFoundException(&quot;Table &quot; + Bytes.toStringBinary(table.getTableName()) + &quot;is not currently available.&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Deque&lt;LoadQueueItem&gt; queue = null;</div><div class="line">	try &#123;</div><div class="line">		queue = discoverLoadQueue(hfofDir);</div><div class="line">		while (!queue.isEmpty()) &#123;                                // ----&gt;  串行化消费队列，提交bulkload</div><div class="line">			LoadQueueItem item = queue.remove();</div><div class="line">			tryLoad(item, conn, table.getTableName(), queue);</div><div class="line">		&#125;</div><div class="line">	&#125; finally &#123;</div><div class="line">		if (queue != null &amp;&amp; !queue.isEmpty()) &#123;</div><div class="line">			StringBuilder err = new StringBuilder();</div><div class="line">			err.append(&quot;-------------------------------------------------\n&quot;);</div><div class="line">			err.append(&quot;Bulk load aborted with some files not yet loaded:\n&quot;);</div><div class="line">			err.append(&quot;-------------------------------------------------\n&quot;);</div><div class="line">			for (LoadQueueItem q : queue) &#123;</div><div class="line">				err.append(&quot;  &quot;).append(q.hfilePath).append(&apos;\n&apos;);</div><div class="line">			&#125;</div><div class="line">			LOG.error(err);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="b-基于0-90版本修改的并行化方案，通过构建线程池来完成。"><a href="#b-基于0-90版本修改的并行化方案，通过构建线程池来完成。" class="headerlink" title="b)  基于0.90版本修改的并行化方案，通过构建线程池来完成。"></a><strong>b)</strong>  基于0.90版本修改的并行化方案，通过构建线程池来完成。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">public boolean doBulkLoad(Path hfofDir, HTable table) throws TableNotFoundException, IOException &#123;</div><div class="line">	boolean isSuccess=false;</div><div class="line">	HConnection conn = table.getConnection();</div><div class="line">	</div><div class="line">	if (!conn.isTableAvailable(table.getTableName())) &#123;</div><div class="line">		throw new TableNotFoundException(&quot;Table &quot; + Bytes.toStringBinary(table.getTableName()) + &quot;is not currently available.&quot;);</div><div class="line">	&#125;</div><div class="line">	List&lt;Deque&lt;LoadQueueItem&gt;&gt; queueList = null;</div><div class="line">	// Deque&lt;LoadQueueItem&gt; queue = null;</div><div class="line">	queueList = discoverLoadQueue(hfofDir);</div><div class="line">	int threadNums=conf.getInt(CONCURRENCY_NUMS, 1);</div><div class="line">	LOG.info(&quot;*********    thread nums = &quot;+threadNums);</div><div class="line">	ExecutorService executorService = Executors.newFixedThreadPool(threadNums);                //  -----&gt; 并行化解决方案</div><div class="line">	List&lt;Future&lt;Boolean&gt;&gt; resultList = new ArrayList&lt;Future&lt;Boolean&gt;&gt;();</div><div class="line">	try&#123;</div><div class="line">		for (Deque&lt;LoadQueueItem&gt; queue : queueList) &#123;</div><div class="line">			Future&lt;Boolean&gt; future =executorService.submit(new LoadThread(queue, conn, table.getTableName()));</div><div class="line">			resultList.add(future);</div><div class="line">		&#125;</div><div class="line">		for (Future&lt;Boolean&gt; result : resultList) &#123;</div><div class="line">			if (!result.get(100, TimeUnit.MINUTES)) &#123;</div><div class="line">				LOG.error(&quot;validatorThread return false&quot;);</div><div class="line">				return false;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		isSuccess = true;</div><div class="line">	&#125;catch(Exception e)&#123;</div><div class="line">		LOG.error(e);</div><div class="line">	&#125;finally&#123;</div><div class="line">		executorService.shutdown();</div><div class="line">		return isSuccess;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="c-官方0-94的版本的代码片段，已经提供了并行化，并且大幅修改了代码，开启并行化，需要手动设置参数-hbase-loadincremental-threads-max，默认值是机器的cpu-cores相关"><a href="#c-官方0-94的版本的代码片段，已经提供了并行化，并且大幅修改了代码，开启并行化，需要手动设置参数-hbase-loadincremental-threads-max，默认值是机器的cpu-cores相关" class="headerlink" title="c) 官方0.94的版本的代码片段，已经提供了并行化，并且大幅修改了代码，开启并行化，需要手动设置参数: hbase.loadincremental.threads.max，默认值是机器的cpu cores相关"></a><strong>c)</strong> 官方0.94的版本的代码片段，已经提供了并行化，并且大幅修改了代码，开启并行化，需要手动设置参数: <strong>hbase.loadincremental.threads.max</strong>，默认值是机器的cpu cores相关</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public void doBulkLoad(Path hfofDir, final HTable table)</div><div class="line">   throws TableNotFoundException, IOException</div><div class="line"> &#123;</div><div class="line">   final HConnection conn = table.getConnection();</div><div class="line"></div><div class="line">   if (!conn.isTableAvailable(table.getTableName())) &#123;</div><div class="line">     throw new TableNotFoundException(&quot;Table &quot; +</div><div class="line">         Bytes.toStringBinary(table.getTableName()) +</div><div class="line">         &quot;is not currently available.&quot;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   // initialize thread pools                                                        ----&gt;  并行化处理加载HFile</div><div class="line">   int nrThreads = cfg.getInt(&quot;hbase.loadincremental.threads.max&quot;,</div><div class="line">       Runtime.getRuntime().availableProcessors());</div><div class="line">   ThreadFactoryBuilder builder = new ThreadFactoryBuilder();</div><div class="line">   builder.setNameFormat(&quot;LoadIncrementalHFiles-%1$d&quot;);</div><div class="line">   ExecutorService pool = new ThreadPoolExecutor(nrThreads, nrThreads,</div><div class="line">       60, TimeUnit.SECONDS,</div><div class="line">       new LinkedBlockingQueue&lt;Runnable&gt;(),</div><div class="line">       builder.build());</div><div class="line">   ((ThreadPoolExecutor)pool).allowCoreThreadTimeOut(true);</div><div class="line"></div><div class="line"></div><div class="line">   ......</div></pre></td></tr></table></figure>
<h3 id="Step-3-查看hfile边界，以决定是否需要split"><a href="#Step-3-查看hfile边界，以决定是否需要split" class="headerlink" title="Step 3. 查看hfile边界，以决定是否需要split"></a>Step 3. 查看hfile边界，以决定是否需要split</h3><p>这个地方就是是否会在客户端发生split的原因<br>直接参考0.94的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">   * Attempt to assign the given load queue item into its target region group.</div><div class="line">   * If the hfile boundary no longer fits into a region, physically splits</div><div class="line">   * the hfile such that the new bottom half will fit and returns the list of</div><div class="line">   * LQI&apos;s corresponding to the resultant hfiles.</div><div class="line">   *</div><div class="line">   * protected for testing</div><div class="line">   */</div><div class="line">  protected List&lt;LoadQueueItem&gt; groupOrSplit(Multimap&lt;ByteBuffer, LoadQueueItem&gt; regionGroups,</div><div class="line">      final LoadQueueItem item, final HTable table,</div><div class="line">      final Pair&lt;byte[][], byte[][]&gt; startEndKeys)</div><div class="line">      throws IOException &#123;</div><div class="line">    final Path hfilePath = item.hfilePath;</div><div class="line">    final FileSystem fs = hfilePath.getFileSystem(getConf());</div><div class="line">    HFile.Reader hfr = HFile.createReader(fs, hfilePath,</div><div class="line">        new CacheConfig(getConf()));</div><div class="line">    final byte[] first, last;</div><div class="line">    try &#123;</div><div class="line">      hfr.loadFileInfo();</div><div class="line">      first = hfr.getFirstRowKey();</div><div class="line">      last = hfr.getLastRowKey();</div><div class="line">    &#125;  finally &#123;</div><div class="line">      hfr.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    LOG.info(&quot;Trying to load hfile=&quot; + hfilePath +                       ----&gt; 从hfile中得到first 和 last的信息</div><div class="line">        &quot; first=&quot; + Bytes.toStringBinary(first) +</div><div class="line">        &quot; last=&quot;  + Bytes.toStringBinary(last));</div><div class="line">    if (first == null || last == null) &#123;</div><div class="line">      assert first == null &amp;&amp; last == null;</div><div class="line">      // TODO what if this is due to a bad HFile?</div><div class="line">      LOG.info(&quot;hfile &quot; + hfilePath + &quot; has no entries, skipping&quot;);</div><div class="line">      return null;</div><div class="line">    &#125;</div><div class="line">    if (Bytes.compareTo(first, last) &gt; 0) &#123;                              </div><div class="line">      throw new IllegalArgumentException(</div><div class="line">      &quot;Invalid range: &quot; + Bytes.toStringBinary(first) +</div><div class="line">      &quot; &gt; &quot; + Bytes.toStringBinary(last));</div><div class="line">    &#125;</div><div class="line">    int idx = Arrays.binarySearch(startEndKeys.getFirst(), first,        ---&gt;  从整个集群的statEndKeys的多列中搜索是否满足该HFile的Region</div><div class="line">        Bytes.BYTES_COMPARATOR);</div><div class="line">    if (idx &lt; 0) &#123;</div><div class="line">      // not on boundary, returns -(insertion index).  Calculate region it</div><div class="line">      // would be in.</div><div class="line">      idx = -(idx + 1) - 1;</div><div class="line">    &#125;</div><div class="line">    final int indexForCallable = idx;</div><div class="line">    boolean lastKeyInRange =</div><div class="line">      Bytes.compareTo(last, startEndKeys.getSecond()[idx]) &lt; 0 ||</div><div class="line">      Bytes.equals(startEndKeys.getSecond()[idx], HConstants.EMPTY_BYTE_ARRAY);</div><div class="line">    if (!lastKeyInRange) &#123;</div><div class="line">      List&lt;LoadQueueItem&gt; lqis = splitStoreFile(item, table,             ---&gt;  如果不满足，就会触发客户端split，调用splitStoreFile方法这里就时效率慢的原因！！！！</div><div class="line">          startEndKeys.getFirst()[indexForCallable],</div><div class="line">          startEndKeys.getSecond()[indexForCallable]);</div><div class="line">      return lqis;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // group regions.</div><div class="line">    regionGroups.put(ByteBuffer.wrap(startEndKeys.getFirst()[idx]), item);         ---&gt; 如果HFile满足区间，或者是已经将不满足区间的HFile切分满足，那么就加到RegionGroup中，等待加载.</div><div class="line">    return null;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Step-4-客户端split的两个方法"><a href="#Step-4-客户端split的两个方法" class="headerlink" title="Step 4. 客户端split的两个方法"></a>Step 4. 客户端split的两个方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">// 决定split的范围，数量，分区</div><div class="line">  protected List&lt;LoadQueueItem&gt; splitStoreFile(final LoadQueueItem item,</div><div class="line">      final HTable table, byte[] startKey,</div><div class="line">      byte[] splitKey) throws IOException &#123;</div><div class="line">    final Path hfilePath = item.hfilePath;</div><div class="line"></div><div class="line">    // We use a &apos;_&apos; prefix which is ignored when walking directory trees</div><div class="line">    // above.</div><div class="line">    final Path tmpDir = new Path(item.hfilePath.getParent(), &quot;_tmp&quot;);</div><div class="line"></div><div class="line">    LOG.info(&quot;HFile at &quot; + hfilePath + &quot; no longer fits inside a single &quot; +</div><div class="line">    &quot;region. Splitting...&quot;);</div><div class="line"></div><div class="line">    String uniqueName = getUniqueName(table.getTableName());</div><div class="line">    HColumnDescriptor familyDesc = table.getTableDescriptor().getFamily(item.family);</div><div class="line">    Path botOut = new Path(tmpDir, uniqueName + &quot;.bottom&quot;);</div><div class="line">    Path topOut = new Path(tmpDir, uniqueName + &quot;.top&quot;);</div><div class="line">    splitStoreFile(getConf(), hfilePath, familyDesc, splitKey,</div><div class="line">        botOut, topOut);</div><div class="line"></div><div class="line">    // Add these back at the *front* of the queue, so there&apos;s a lower</div><div class="line">    // chance that the region will just split again before we get there.</div><div class="line">    List&lt;LoadQueueItem&gt; lqis = new ArrayList&lt;LoadQueueItem&gt;(2);</div><div class="line">    lqis.add(new LoadQueueItem(item.family, botOut));</div><div class="line">    lqis.add(new LoadQueueItem(item.family, topOut));</div><div class="line"></div><div class="line">    LOG.info(&quot;Successfully split into new HFiles &quot; + botOut + &quot; and &quot; + topOut);      // 如果split成功，我们会看到这些日志...</div><div class="line">    return lqis;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  </div><div class="line">  // 真正调用执行split,copy....</div><div class="line">  </div><div class="line">    /**</div><div class="line">   * Split a storefile into a top and bottom half, maintaining</div><div class="line">   * the metadata, recreating bloom filters, etc.</div><div class="line">   */</div><div class="line">  static void splitStoreFile(</div><div class="line">      Configuration conf, Path inFile,</div><div class="line">      HColumnDescriptor familyDesc, byte[] splitKey,</div><div class="line">      Path bottomOut, Path topOut) throws IOException</div><div class="line">  &#123;</div><div class="line">    // Open reader with no block cache, and not in-memory</div><div class="line">    Reference topReference = new Reference(splitKey, Range.top);</div><div class="line">    Reference bottomReference = new Reference(splitKey, Range.bottom);</div><div class="line"></div><div class="line">    copyHFileHalf(conf, inFile, topOut, topReference, familyDesc);                    -----&gt; 客户端split的真正copy的方法</div><div class="line">    copyHFileHalf(conf, inFile, bottomOut, bottomReference, familyDesc); </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="3-Q-amp-A"><a href="#3-Q-amp-A" class="headerlink" title="3. Q&amp;A"></a><strong>3. Q&amp;A</strong></h2><h3 id="1-Q-目前的工具是否是并行化加载"><a href="#1-Q-目前的工具是否是并行化加载" class="headerlink" title="1)  Q:  目前的工具是否是并行化加载?"></a><strong>1)  Q:  目前的工具是否是并行化加载?</strong></h3><pre><code>通过上面的分析，我们可以看到，从0.94开始就已经是有并行化处理了，因此我们不需要再像我之前的那种方式去做了。只要定义好自己的线程池大小就ok.   
但我们也需要注意的是，由于**LoadIncrementalHFiles** 工具并不是M/R job，所以不要指望能直接通过M/R来提高效率。  
</code></pre><h3 id="2-Q-如果避免split"><a href="#2-Q-如果避免split" class="headerlink" title="2)  Q:  如果避免split?"></a><strong>2)  Q:  如果避免split?</strong></h3><pre><code>split有两个定义。一个是客户端的split，另一个是Region Server的split。  
在空表情况下，通过预分区的方式，只要key分的准确，就不会触发客户端的split。结合hbase 原本的 split size 参数，使HFile对应的HRegion大小合适，不会造成RSr的split.
</code></pre><h3 id="3-Q-对空表的bulkload的过程中，可否正常读写"><a href="#3-Q-对空表的bulkload的过程中，可否正常读写" class="headerlink" title="3)  Q:  对空表的bulkload的过程中，可否正常读写?"></a><strong>3)  Q:  对空表的bulkload的过程中，可否正常读写?</strong></h3><pre><code>读肯定是没有问题的，写的话，如果数据量不大，不触发Region的split，则也没有关系。  
</code></pre><h3 id="4-Q-为什么bulkload的过程中，在数据已经准备的情况下，效率那么快，秒级别加载，并且不会disable-Region"><a href="#4-Q-为什么bulkload的过程中，在数据已经准备的情况下，效率那么快，秒级别加载，并且不会disable-Region" class="headerlink" title="4)  Q:  为什么bulkload的过程中，在数据已经准备的情况下，效率那么快，秒级别加载，并且不会disable Region?"></a><strong>4)  Q:  为什么bulkload的过程中，在数据已经准备的情况下，效率那么快，秒级别加载，并且不会disable Region?</strong></h3><pre><code>前面只分析了Bulkload的客户端代码，如果去翻阅一下服务端代码我们可以知道。对于RS来说，bulkload就两件事情，第一件是mv文件，第二件是在RS的memory里加上新HFile的meta信息。  
</code></pre><h3 id="5-Q-对于非空表的增量数据bulkload，基本策略有哪些"><a href="#5-Q-对于非空表的增量数据bulkload，基本策略有哪些" class="headerlink" title="5)  Q:  对于非空表的增量数据bulkload，基本策略有哪些?"></a><strong>5)  Q:  对于非空表的增量数据bulkload，基本策略有哪些?</strong></h3><pre><code>参考步骤如下:  
a)  对新增HFiles大小做预估计，如果当前cluster可以容纳，则不需要预分区，否则，可以先预分区。  
b)  通过M/R对HFile做符合当前集群分区情况进行切分。  
c)  加载。  
</code></pre><p>对此，官方设计中有一段说明:<br>If the region boundaries have changed during the course of bulk load preparation, or between the preparation and completion steps, the completebulkloads utility will automatically split the data files into pieces corresponding to the new boundaries. This process is not optimally efficient, so users should take care to minimize the delay between preparing a bulk load and importing it into the cluster, especially if other clients are simultaneously loading data through other means.</p>
<p>大致意思是，即使客户端工具能够完成split的工作，但并不是最有效的方式，用户应该注意边界问题。</p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2015/08/27/hbase-bulkload/" data-id="cjqov2qmr00083q0941ikxb4n" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2015/08/27/hbase-bulkload/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-elasticsearch_dc" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2015/08/10/elasticsearch_dc/">为ElasticSearch 添加支持跨DC的特性</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/08/10/elasticsearch_dc/">
            <time datetime="2015-08-10T01:50:22.000Z" itemprop="datePublished">2015-08-10</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/elasticsearch/">elasticsearch</a>, <a class="tag-link" href="/tags/search/">search</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>无意间发现，去年年初提到社区的改动，在去年8月得到回复，虽然没有被采纳…<br><a href="https://github.com/elastic/elasticsearch/pull/4651#issuecomment-51578376" target="_blank" rel="external">https://github.com/elastic/elasticsearch/pull/4651#issuecomment-51578376</a><br>对方提出两点:</p>
<ol>
<li>不赞成ElasticSearch跨越数据中心构建。   </li>
<li>认为同步和延迟会造成比较大的问题。    </li>
</ol>
<h3 id="不过，目前为止，我认为这个特性有它的价值，所以在此分享一些当初的设计思想和改造方法。同时，透露一下，这个改造在公司内部也正常稳定运行了近一年多"><a href="#不过，目前为止，我认为这个特性有它的价值，所以在此分享一些当初的设计思想和改造方法。同时，透露一下，这个改造在公司内部也正常稳定运行了近一年多" class="headerlink" title="不过，目前为止，我认为这个特性有它的价值，所以在此分享一些当初的设计思想和改造方法。同时，透露一下，这个改造在公司内部也正常稳定运行了近一年多"></a><strong>不过，目前为止，我认为这个特性有它的价值，所以在此分享一些当初的设计思想和改造方法。同时，透露一下，这个改造在公司内部也正常稳定运行了近一年多</strong></h3><h1 id="改进点"><a href="#改进点" class="headerlink" title="改进点"></a>改进点</h1><p>Elastic Search的节点设计思想是，每一组索引分片，由一个primary做write操作，而前天的replica做读操作。<br>那么，如果对于一个跨数据中心的elastic Search设计，将会因为以下的场景，带来一些问题:</p>
<ol>
<li>如果所有的写操作是由一个数据中心完成（事实上，大多数情况都是如此），由一个主的数据中心处理数据，然后分发到其他的数据中心(跨location)</li>
<li>而ES的Primary的规则，并不支持将Primary都分配在同属于一个location的Node，而是会根据其自身的集中策略来分配</li>
<li>根据以上两点，最终的结果是: 如果由两个数据中心，Primary可能分配到任何的数据中心，造成write操作会分散在不同的location</li>
</ol>
<h3 id="而我们要做的是，提供一种策略，使得primary分配到同一个location下的index分片"><a href="#而我们要做的是，提供一种策略，使得primary分配到同一个location下的index分片" class="headerlink" title="而我们要做的是，提供一种策略，使得primary分配到同一个location下的index分片"></a><strong>而我们要做的是，提供一种策略，使得primary分配到同一个location下的index分片</strong></h3><h1 id="改进效果"><a href="#改进效果" class="headerlink" title="改进效果"></a>改进效果</h1><p><img src="/img/elasticsearch_dc/1.png" alt="分布"></p>
<h3 id="这种策略可以支持任何的情况"><a href="#这种策略可以支持任何的情况" class="headerlink" title="这种策略可以支持任何的情况:"></a>这种策略可以支持任何的情况:</h3><ol>
<li>primary所在的location全部down掉，只剩下replica的location</li>
<li>任意顺序启动Node.</li>
<li>任意一种HA的可能情况。  </li>
</ol>
<h3 id="代码部分，可参考我已经提交的版本"><a href="#代码部分，可参考我已经提交的版本" class="headerlink" title="代码部分，可参考我已经提交的版本"></a>代码部分，可参考我已经提交的版本</h3><p><a href="https://github.com/3h-william/elasticsearch-dc-version0.0.1" target="_blank" rel="external">https://github.com/3h-william/elasticsearch-dc-version0.0.1</a></p>
<hr>
<p>作者：3h_william<br>联系: <a href="https://github.com/3h-william" target="_blank" rel="external">https://github.com/3h-william</a><br>出处：<a href="http://3h-william.github.io">http://3h-william.github.io</a>  </p>
<hr>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://3h-william.github.io/2015/08/10/elasticsearch_dc/" data-id="cjqov2qmn00043q090mhveo9b" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://3h-william.github.io/2015/08/10/elasticsearch_dc/#comments" class="article-comment-link">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2019/01/09/raft/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2019/01/09/raft/" class="title">raft协议的实现</a></p>
                            <p class="item-date"><time datetime="2019-01-09T07:00:00.000Z" itemprop="datePublished">2019-01-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/02/25/akka_split_brain/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/02/25/akka_split_brain/" class="title">Akka集群对于脑裂的策略</a></p>
                            <p class="item-date"><time datetime="2017-02-25T09:35:00.000Z" itemprop="datePublished">2017-02-25</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/24/lft/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/01/24/lft/" class="title">新一代分布式调度系统--雷峰塔架构</a></p>
                            <p class="item-date"><time datetime="2017-01-24T07:30:11.000Z" itemprop="datePublished">2017-01-24</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/24/akka/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/01/24/akka/" class="title">项目中，使用akka的一些经验和总结</a></p>
                            <p class="item-date"><time datetime="2017-01-24T07:00:11.000Z" itemprop="datePublished">2017-01-24</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2015/11/10/zookeeper_stuck_dns_network/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2015/11/10/zookeeper_stuck_dns_network/" class="title">使用Zookeeper过程中遇到客户端stuck的问题和解决建议</a></p>
                            <p class="item-date"><time datetime="2015-11-10T01:18:11.000Z" itemprop="datePublished">2015-11-10</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MachineLearning/">MachineLearning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/akka/">akka</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/etcd/">etcd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/">hbase</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/">hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raft/">raft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/">scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/search/">search</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqoop/">sqoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tsdb/">tsdb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/">zookeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式系统/">分布式系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术产品/">技术产品</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术架构/">技术架构</a><span class="tag-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/MachineLearning/" style="font-size: 10px;">MachineLearning</a> <a href="/tags/akka/" style="font-size: 20px;">akka</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/hbase/" style="font-size: 20px;">hbase</a> <a href="/tags/hive/" style="font-size: 10px;">hive</a> <a href="/tags/raft/" style="font-size: 10px;">raft</a> <a href="/tags/scala/" style="font-size: 10px;">scala</a> <a href="/tags/search/" style="font-size: 10px;">search</a> <a href="/tags/sqoop/" style="font-size: 10px;">sqoop</a> <a href="/tags/tsdb/" style="font-size: 10px;">tsdb</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/分布式系统/" style="font-size: 10px;">分布式系统</a> <a href="/tags/技术产品/" style="font-size: 10px;">技术产品</a> <a href="/tags/技术架构/" style="font-size: 15px;">技术架构</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            <span id="busuanzi_container_site_pv">
                本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span></br>
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次
            </span></br>
            &copy; 2019 3h.william@gmail.com<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        </div>
    </div>
</footer>

        
    
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126168"></script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>